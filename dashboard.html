<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Lead Dashboard</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 12px; }

    .filters { margin-bottom: 14px; display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end; }
    .filters label { display:flex; flex-direction:column; font-size: 12px; gap:6px; }
    .filters select, .filters input[type="date"] { padding: 6px 8px; min-width: 150px; }
    button#apply { height: 36px; padding: 0 14px; cursor: pointer; }

    .sortbox { display:flex; gap:8px; align-items:center; margin: 4px 0 14px; font-size: 14px; }
    .sortbox select { padding: 6px 8px; }

    .table-wrap { position: relative; }
    .statusbar { text-align: right; font-size: 12px; margin: 6px 0 8px; opacity:.8; }

    /* Loader overlay */
    .loader {
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(255,255,255,.7); backdrop-filter:saturate(150%) blur(2px); z-index: 2;
      font-weight:600;
    }
    .loader.show { display:flex; }

    table { width:100%; }
    #leadsTable td, #leadsTable th { border-top: 1px solid #e8edf3; } /* dunne lichtgrijze rij-lijnen */
    .totals { margin-top: 10px; font-weight: 600; }

    /* Pastel tinten per niveau (allemaal als echte tabelrijen) */
    .level1 td { background: #f6f9ff; }           /* licht pastel blauw */
    .level1.shown td { background: #eef3ff; }
    .level2 td { background: #f7f7f9; }           /* licht grijs */
    .level3 td { background: #eef6ff; }           /* andere lichtblauw tint */

    .control { cursor: pointer; font-weight: 600; white-space: nowrap; }
    .arrow { display:inline-block; width:1em; text-align:center; margin-right:4px; }

    .empty { padding: 16px; font-style: italic; opacity:.8; }
  </style>
</head>
<body>
  <h1>Lead Dashboard</h1>

  <div class="filters">
    <label>Offer ID
      <select id="offerFilter"><option value="">Alle</option></select>
    </label>
    <label>Campaign ID
      <select id="campaignFilter"><option value="">Alle</option></select>
    </label>
    <label>Affiliate ID
      <select id="affiliateFilter"><option value="">Alle</option></select>
    </label>
    <label>Sub ID
      <select id="subFilter"><option value="">Alle</option></select>
    </label>
    <label>Vanaf
      <input type="date" id="fromDate" />
    </label>
    <label>Tot
      <input type="date" id="toDate" />
    </label>
    <label>Groepering
      <select id="groupOrder">
        <option value="day,affiliate,offer" selected>Dag → Affiliate → Offer</option>
        <option value="affiliate,day,offer">Affiliate → Dag → Offer</option>
        <option value="offer,affiliate,day">Offer → Affiliate → Dag</option>
      </select>
    </label>
    <button id="apply">Toepassen</button>
  </div>

  <div class="sortbox">
    Sorteren op:
    <select id="sortBy">
      <option value="leads" selected>Aantal Leads</option>
      <option value="cost">Kosten</option>
    </select>
    <select id="sortDir">
      <option value="desc" selected>Desc</option>
      <option value="asc">Asc</option>
    </select>
  </div>

  <div class="table-wrap">
    <div id="loader" class="loader">Bezig met laden…</div>
    <div class="statusbar" id="statusbar"></div>
    <table id="leadsTable" class="display"></table>
    <div id="emptyState" class="empty" style="display:none;">Geen data gevonden voor de gekozen filters.</div>
  </div>

  <div class="totals" id="totals"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script>
    const BASE = ''; // zelfde origin
    const toMoney = (n) => Number(n || 0).toFixed(2);
    const showLoader = (on) => document.getElementById('loader').classList.toggle('show', !!on);
    const setStatus = (txt) => document.getElementById('statusbar').textContent = txt || '';

    async function fetchFilters() {
      const r = await fetch(`${BASE}/api/dashboard-filters`);
      const { data } = await r.json();
      const fill = (id, values) => {
        const sel = document.getElementById(id);
        values.forEach(v => { const o = document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
      };
      fill('offerFilter', data.offer_ids);
      fill('campaignFilter', data.campaign_ids);
      fill('affiliateFilter', data.affiliate_ids);
      fill('subFilter', data.sub_ids);
    }

    async function fetchTree() {
      const params = new URLSearchParams();
      const v = (id) => document.getElementById(id).value;
      if (v('offerFilter'))     params.append('offer_id', v('offerFilter'));
      if (v('campaignFilter'))  params.append('campaign_id', v('campaignFilter'));
      if (v('affiliateFilter')) params.append('affiliate_id', v('affiliateFilter'));
      if (v('subFilter'))       params.append('sub_id', v('subFilter'));
      if (v('fromDate'))        params.append('date_from', v('fromDate'));
      if (v('toDate'))          params.append('date_to', v('toDate'));
      params.append('order', v('groupOrder') || 'day,affiliate,offer');

      const r = await fetch(`${BASE}/api/dashboard-aggregate?` + params.toString());
      if (!r.ok) throw new Error('Kon data niet laden');
      const { data } = await r.json();
      return data; // { order:[...], tree:[...] }
    }

    function renderTotals(flat) {
      const totalLeads = flat.reduce((s, r) => s + Number(r.leads || 0), 0);
      const totalCost  = flat.reduce((s, r) => s + Number(r.cost  || 0), 0);
      document.getElementById('totals').textContent =
        `Totaal: ${totalLeads.toLocaleString('nl-NL')} leads • Kosten € ${toMoney(totalCost)}`;
    }

    function sortChildren(rows) {
      const by = document.getElementById('sortBy').value;     // 'leads' | 'cost'
      const dir = document.getElementById('sortDir').value;   // 'asc' | 'desc'
      rows.sort((a, b) => {
        const av = Number(a[by] || 0), bv = Number(b[by] || 0);
        return dir === 'asc' ? av - bv : bv - av;
      });
      return rows;
    }

    function flattenTop(tree) {
      return tree.map(n => ({
        level: 1,
        day: n.label, affiliate: '', offer: '',
        leads: n.leads, cost: n.cost,
        children: n.children || []
      }));
    }

    function makeTd(text, cls='') {
      const td = document.createElement('td');
      if (cls) td.className = cls;
      td.textContent = text ?? '';
      return td;
    }
    function makeTdHTML(html, cls='') {
      const td = document.createElement('td');
      if (cls) td.className = cls;
      td.innerHTML = html;
      return td;
    }

    async function loadTable() {
      showLoader(true);
      setStatus('Data ophalen…');

      try {
        const { order, tree } = await fetchTree();
        const [L1, L2, L3] = order;
        const top = flattenTop(tree);
        const hasData = top.length > 0;

        document.getElementById('emptyState').style.display = hasData ? 'none' : 'block';
        renderTotals(top);

        const columns = [
          { title: (L1 === 'day' ? 'Datum' : (L1 === 'affiliate' ? 'Affiliate ID' : 'Offer ID')),
            data: 'day',
            className: 'control',
            render: (data, type, row) => {
              const has = row.children && row.children.length;
              const txt = row.day || '';
              return has ? `<span class="arrow">▶</span>${txt}` : txt;
            }
          },
          { title: (L2 === 'day' ? 'Datum' : (L2 === 'affiliate' ? 'Affiliate ID' : 'Offer ID')), data: 'affiliate',
            render: (d)=> d || '' },
          { title: (L3 === 'day' ? 'Datum' : (L3 === 'affiliate' ? 'Affiliate ID' : 'Offer ID')), data: 'offer',
            render: (d)=> d || '' },
          { title: 'Aantal Leads', data: 'leads' },
          { title: 'Kosten', data: 'cost', render: d => toMoney(d) }
        ];

        if ($.fn.dataTable.isDataTable('#leadsTable')) {
          const dt = $('#leadsTable').DataTable();
          dt.clear().rows.add(top).draw();
        } else {
          $('#leadsTable').DataTable({
            data: top,
            order: [[0, 'asc']],
            columns
          });
        }

        const table = $('#leadsTable').DataTable();
        $('#leadsTable tbody tr').addClass('level1');

        // klik: uitklappen naar L2 (we voegen echte tabelrijen toe onder de parent)
        $('#leadsTable tbody').off('click').on('click', 'td.control', function () {
          const tr = $(this).closest('tr');
          const row = table.row(tr);
          const rowData = row.data();

          if (!rowData.children || !rowData.children.length) return;

          const isOpen = tr.hasClass('shown');
          if (isOpen) {
            // verwijder alle direct onderliggende level2/level3 rijen die bij deze parent horen (tot we een volgende level1 tegenkomen)
            let next = tr.next();
            while (next.length && !next.hasClass('level1')) {
              const tmp = next.next();
              next.remove();
              next = tmp;
            }
            tr.removeClass('shown');
            $(this).find('.arrow').text('▶');
            return;
          }

          // eerst sluiten wat eventueel openstaat vlak eronder
          let next = tr.next();
          while (next.length && !next.hasClass('level1')) {
            const tmp = next.next();
            next.remove();
            next = tmp;
          }

          tr.addClass('shown');
          $(this).find('.arrow').text('▼');

          const children = sortChildren(rowData.children.slice());

          // Voeg per child één level2 rij toe (5 kolommen, netjes onder de koppen)
          children.forEach((c) => {
            const rowEl = document.createElement('tr');
            rowEl.className = 'level2';
            // kolom 1: leeg (dag staat in parent)
            rowEl.appendChild(makeTd(''));
            // kolom 2: affiliate (met pijltje indien weer kinderen)
            const arrow = (c.children && c.children.length) ? '<span class="arrow">▶</span>' : '<span class="arrow"></span>';
            rowEl.appendChild(makeTdHTML(`${arrow}${c.label}`, 'control'));
            // kolom 3: leeg (offer komt in level3)
            rowEl.appendChild(makeTd(''));
            // kolom 4: leads
            rowEl.appendChild(makeTd(String(c.leads)));
            // kolom 5: cost
            rowEl.appendChild(makeTd(toMoney(c.cost)));

            // koppel data voor next level
            rowEl.dataset.hasChildren = (c.children && c.children.length) ? '1' : '0';
            rowEl._children = sortChildren((c.children || []).slice());

            // insert onder parent
            $(rowEl).insertAfter(tr);

            // klik op level2 → toon/verborgen level3
            $(rowEl).off('click').on('click', 'td.control', function (e) {
              e.stopPropagation(); // niet bubbelen naar level1 klik
              const thisTr = $(this).closest('tr');
              const hasChildren = thisTr.get(0).dataset.hasChildren === '1';
              const kids = thisTr.get(0)._children || [];
              if (!hasChildren) return;

              const open = thisTr.hasClass('shown');
              if (open) {
                // verwijder opvolgende level3-rijen tot we een rij tegenkomen die geen level3 is
                let nx = thisTr.next();
                while (nx.length && nx.hasClass('level3')) {
                  const t2 = nx.next();
                  nx.remove();
                  nx = t2;
                }
                thisTr.removeClass('shown');
                $(this).find('.arrow').text('▶');
                return;
              }

              // eerst bestaande level3 direct onder deze rij sluiten
              let nx = thisTr.next();
              while (nx.length && nx.hasClass('level3')) {
                const t2 = nx.next();
                nx.remove();
                nx = t2;
              }

              thisTr.addClass('shown');
              $(this).find('.arrow').text('▼');

              kids.forEach(k => {
                const r3 = document.createElement('tr');
                r3.className = 'level3';
                // kolommen: [leeg, leeg, offer, leads, cost]
                r3.appendChild(makeTd(''));
                r3.appendChild(makeTd(''));
                r3.appendChild(makeTd(k.label));
                r3.appendChild(makeTd(String(k.leads)));
                r3.appendChild(makeTd(toMoney(k.cost)));
                $(r3).insertAfter(thisTr);
              });
            });
          });
        });

        const now = new Date();
        setStatus('Bijgewerkt: ' + now.toLocaleTimeString('nl-NL'));
      } catch (e) {
        console.error(e);
        alert('Kon dashboard data niet laden.');
      } finally {
        showLoader(false);
      }
    }

    document.getElementById('apply').addEventListener('click', loadTable);
    document.getElementById('sortBy').addEventListener('change', loadTable);
    document.getElementById('sortDir').addEventListener('change', loadTable);

    // Init: standaard 30 dagen terug tot vandaag
    (function setDefaultDates() {
      const toISO = (d) => d.toISOString().slice(0,10);
      const now = new Date();
      const past = new Date(); past.setDate(now.getDate() - 30);
      document.getElementById('fromDate').value = toISO(past);
      document.getElementById('toDate').value = toISO(now);
    })();

    (async () => {
      await fetchFilters();
      await loadTable();
    })();
  </script>
</body>
</html>
