<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Lead Dashboard</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 12px; }

    .filters { margin-bottom: 14px; display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end; }
    .filters label { display:flex; flex-direction:column; font-size: 12px; gap:6px; }
    .filters select, .filters input[type="date"] { padding: 6px 8px; min-width: 150px; }
    button#apply { height: 36px; padding: 0 14px; cursor: pointer; }

    .statusbar { text-align: right; font-size: 12px; margin: 6px 0 8px; opacity:.8; }
    .totals { margin-top: 10px; font-weight: 600; }

    .level1 td { background: #f6f9ff; }
    .level1.shown td { background: #eef3ff; }
    .level2 td { background: #f7f7f9; }
    .level3 td { background: #eef6ff; }

    .control { cursor: pointer; font-weight: 600; white-space: nowrap; }
    .arrow { display:inline-block; width:1em; text-align:center; margin-right:4px; }
  </style>
</head>
<body>
  <h1>Lead Dashboard</h1>

  <div class="filters">
    <label>Offer ID <select id="offerFilter"><option value="">Alle</option></select></label>
    <label>Campaign ID <select id="campaignFilter"><option value="">Alle</option></select></label>
    <label>Affiliate ID <select id="affiliateFilter"><option value="">Alle</option></select></label>
    <label>Sub ID <select id="subFilter"><option value="">Alle</option></select></label>
    <label>Vanaf <input type="date" id="fromDate" /></label>
    <label>Tot <input type="date" id="toDate" /></label>
    <label>Groepering
      <select id="groupOrder">
        <option value="day,affiliate,offer" selected>Dag → Affiliate → Offer</option>
        <option value="affiliate,day,offer">Affiliate → Dag → Offer</option>
        <option value="offer,affiliate,day">Offer → Affiliate → Dag</option>
      </select>
    </label>
    <button id="apply">Toepassen</button>
  </div>

  <div class="statusbar" id="statusbar"></div>
  <table id="leadsTable" class="display"></table>
  <div class="totals" id="totals"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script>
    const BASE = '';
    let l1Map = new Map();
    const openL1 = new Set();

    const toMoney = (n) => Number(n || 0).toFixed(2);
    const setStatus = (txt) => document.getElementById('statusbar').textContent = txt || '';

    async function fetchTree() {
      const params = new URLSearchParams();
      const v = (id) => document.getElementById(id).value;
      if (v('offerFilter'))     params.append('offer_id', v('offerFilter'));
      if (v('campaignFilter'))  params.append('campaign_id', v('campaignFilter'));
      if (v('affiliateFilter')) params.append('affiliate_id', v('affiliateFilter'));
      if (v('subFilter'))       params.append('sub_id', v('subFilter'));
      if (v('fromDate'))        params.append('date_from', v('fromDate'));
      if (v('toDate'))          params.append('date_to', v('toDate'));
      params.append('order', v('groupOrder') || 'day,affiliate,offer');
      const r = await fetch(`${BASE}/api/dashboard-aggregate?` + params.toString());
      const { data } = await r.json();
      return data;
    }

    function indexMaps(tree) {
      l1Map.clear();
      for (const n1 of tree) {
        l1Map.set(n1.key, n1);
      }
    }

    function toTopRows(tree) {
      return tree.map(n=>({
        key: n.key, day: n.label, affiliate:'', offer:'',
        leads: n.leads, cost: n.cost, children: n.children||[]
      }));
    }

    function makeTd(text, cls='') {
      const td = document.createElement('td');
      if (cls) td.className = cls;
      td.textContent = text ?? '';
      return td;
    }
    function makeTdHTML(html, cls='') {
      const td = document.createElement('td');
      if (cls) td.className = cls;
      td.innerHTML = html;
      return td;
    }

    function expandLevel1(tr, node) {
      node.children.forEach(c=>{
        const rowEl = document.createElement('tr');
        rowEl.className = 'level2';
        rowEl.appendChild(makeTd(''));
        rowEl.appendChild(makeTdHTML(`${c.children?.length ? '<span class="arrow">▶</span>' : ''}${c.label}`, 'control'));
        rowEl.appendChild(makeTd(''));
        rowEl.appendChild(makeTd(String(c.leads)));
        rowEl.appendChild(makeTd(toMoney(c.cost)));
        $(rowEl).insertAfter(tr);
      });
    }

    function collapseLevel1(tr) {
      let next = tr.next();
      while (next.length && !next.hasClass('level1')) {
        const tmp = next.next();
        next.remove();
        next = tmp;
      }
    }

    async function loadDataAndRender() {
      try {
        const { order, tree } = await fetchTree();
        indexMaps(tree);
        const topRows = toTopRows(tree);

        const columns = [
          { title:'Datum', data:'day', className:'control',
            render:(data,type,row)=>{
              return row.children?.length ? `<span class="arrow">▶</span>${row.day}` : row.day;
            }
          },
          { title:'Affiliate ID', data:'affiliate' },
          { title:'Offer ID', data:'offer' },
          { title:'Aantal Leads', data:'leads' },
          { title:'Kosten', data:'cost', render:d=>toMoney(d) }
        ];

        let dt;
        if ($.fn.dataTable.isDataTable('#leadsTable')) {
          dt = $('#leadsTable').DataTable();
          dt.clear().rows.add(topRows).draw(false);
        } else {
          dt = $('#leadsTable').DataTable({ data: topRows, columns, order:[[0,'asc']] });
        }

        $('#leadsTable tbody tr').addClass('level1');

        // ✅ Click handler die meerdere dagen tegelijk toestaat
        $('#leadsTable tbody').off('click').on('click','td.control',function(){
          const tr = $(this).closest('tr');
          const row = dt.row(tr);
          const data = row.data();
          const node = l1Map.get(data.key);

          if (!node?.children?.length) return;

          if (tr.hasClass('shown')) {
            collapseLevel1(tr);
            tr.removeClass('shown');
            $(this).find('.arrow').text('▶');
            openL1.delete(data.key);
          } else {
            expandLevel1(tr, node);
            tr.addClass('shown');
            $(this).find('.arrow').text('▼');
            openL1.add(data.key);
          }
        });

        // ✅ Bij sorteren: alle geopende dagen heropenen
        dt.off('order.dt').on('order.dt', function(){
          $('.level2').remove();
          $('.level1').removeClass('shown').find('.arrow').text('▶');
          $('#leadsTable tbody tr.level1').each(function(){
            const tr = $(this);
            const row = dt.row(tr);
            const data = row.data();
            if (openL1.has(data.key)) {
              const node = l1Map.get(data.key);
              expandLevel1(tr, node);
              tr.addClass('shown');
              tr.find('.arrow').first().text('▼');
            }
          });
        });

        const now = new Date();
        setStatus('Bijgewerkt: ' + now.toLocaleTimeString('nl-NL'));
      } catch (e) {
        console.error(e);
        alert(e?.message || 'Kon dashboard data niet laden.');
      }
    }

    document.getElementById('apply').addEventListener('click', loadDataAndRender);

    // Default: deze maand
    (function setDefaultDates(){
      const toISO = (d)=>d.toISOString().slice(0,10);
      const to = new Date();
      const from = new Date(to.getFullYear(), to.getMonth(), 1);
      document.getElementById('fromDate').value = toISO(from);
      document.getElementById('toDate').value   = toISO(to);
    })();

    (async () => { await loadDataAndRender(); })();
  </script>
</body>
</html>
