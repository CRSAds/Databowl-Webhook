<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Lead Dashboard</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 16px; }
    .filters { margin-bottom: 20px; display:flex; gap:16px; flex-wrap:wrap; align-items: end; }
    .filters label { display:flex; flex-direction:column; font-size: 12px; gap:6px; }
    .filters select, .filters input[type="date"] { padding: 6px 8px; min-width: 160px; }
    button#apply, button.group-open { height: 36px; padding: 0 14px; cursor: pointer; }
    table { width: 100%; }
    .totals { margin-top: 10px; font-weight: 600; }
    .details { background: rgba(0,0,0,0.03); }
    .control { cursor: pointer; font-weight: 600; }
  </style>
</head>
<body>
  <h1>Lead Dashboard</h1>

  <div class="filters">
    <label>Offer ID
      <select id="offerFilter"><option value="">Alle</option></select>
    </label>
    <label>Campaign ID
      <select id="campaignFilter"><option value="">Alle</option></select>
    </label>
    <label>Affiliate ID
      <select id="affiliateFilter"><option value="">Alle</option></select>
    </label>
    <label>Sub ID
      <select id="subFilter"><option value="">Alle</option></select>
    </label>
    <label>Vanaf
      <input type="date" id="fromDate" />
    </label>
    <label>Tot
      <input type="date" id="toDate" />
    </label>
    <label>Groepering
      <select id="groupOrder">
        <option value="day,affiliate,offer" selected>Dag → Affiliate → Offer</option>
        <option value="affiliate,day,offer">Affiliate → Dag → Offer</option>
        <option value="offer,affiliate,day">Offer → Affiliate → Dag</option>
      </select>
    </label>
    <button id="apply">Toepassen</button>
  </div>

  <table id="leadsTable" class="display"></table>
  <div class="totals" id="totals"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script>
    const BASE = ''; // zelfde origin

    // ---------- helpers ----------
    const toMoney = (n) => Number(n || 0).toFixed(2);

    async function fetchFilters() {
      const r = await fetch(`${BASE}/api/dashboard-filters`);
      const { data } = await r.json();
      const fill = (id, values) => {
        const sel = document.getElementById(id);
        values.forEach(v => { const o = document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
      };
      fill('offerFilter', data.offer_ids);
      fill('campaignFilter', data.campaign_ids);
      fill('affiliateFilter', data.affiliate_ids);
      fill('subFilter', data.sub_ids);
    }

    async function fetchTree() {
      const params = new URLSearchParams();
      const v = (id) => document.getElementById(id).value;
      if (v('offerFilter'))     params.append('offer_id', v('offerFilter'));
      if (v('campaignFilter'))  params.append('campaign_id', v('campaignFilter'));
      if (v('affiliateFilter')) params.append('affiliate_id', v('affiliateFilter'));
      if (v('subFilter'))       params.append('sub_id', v('subFilter'));
      if (v('fromDate'))        params.append('date_from', v('fromDate'));
      if (v('toDate'))          params.append('date_to', v('toDate'));
      params.append('order', v('groupOrder') || 'day,affiliate,offer');

      const r = await fetch(`${BASE}/api/dashboard-aggregate?` + params.toString());
      if (!r.ok) throw new Error('Kon tree niet laden');
      const { data } = await r.json();
      return data; // { order: [...], tree: [...] }
    }

    function renderTotals(flat) {
      const totalLeads = flat.reduce((s, r) => s + Number(r.leads || 0), 0);
      const totalCost  = flat.reduce((s, r) => s + Number(r.cost  || 0), 0);
      document.getElementById('totals').textContent =
        `Totaal: ${totalLeads.toLocaleString('nl-NL')} leads • Kosten € ${toMoney(totalCost)}`;
    }

    // Flatten top-level for DataTable; we voegen zelf child-tables toe bij klik.
    function flattenTop(tree) {
      return tree.map(n => ({
        key: n.key,
        label: n.label,
        leads: n.leads,
        cost: n.cost,
        children: n.children || []
      }));
    }

    function buildChildTable(rows, levelName) {
      // eenvoudige HTML-tabel voor child-rijen
      const t = document.createElement('table');
      t.className = 'display details';
      t.style.width = '100%';
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr><th>${levelName}</th><th>Aantal Leads</th><th>Kosten</th></tr>`;
      t.appendChild(thead);
      const tbody = document.createElement('tbody');
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="control">${r.label}</td><td>${r.leads}</td><td>${toMoney(r.cost)}</td>`;
        tr.dataset.hasChildren = r.children && r.children.length ? '1' : '0';
        tr._children = r.children || [];
        tbody.appendChild(tr);
      });
      t.appendChild(tbody);
      return t;
    }

    async function loadTable() {
      const { order, tree } = await fetchTree();
      const L1 = order[0], L2 = order[1], L3 = order[2];
      const top = flattenTop(tree);

      renderTotals(top);

      // (Re)init DataTable
      if ($.fn.dataTable.isDataTable('#leadsTable')) {
        const dt = $('#leadsTable').DataTable();
        dt.clear().rows.add(top).draw();
      } else {
        $('#leadsTable').DataTable({
          data: top,
          order: [[0, 'asc']],
          columns: [
            { title: (L1 === 'day' ? 'Datum' : (L1 === 'affiliate' ? 'Affiliate ID' : 'Offer ID')),
              data: 'label',
              className: 'control',
              render: (data, type, row) => row.children && row.children.length ? `▶ ${data}` : data
            },
            { title: 'Aantal Leads', data: 'leads' },
            { title: 'Kosten', data: 'cost', render: d => toMoney(d) }
          ]
        });
      }

      // Klik-handlers voor uitklappen (L2 en L3)
      const table = $('#leadsTable').DataTable();

      $('#leadsTable tbody').off('click').on('click', 'td.control', function () {
        const tr = $(this).closest('tr');
        const row = table.row(tr);
        const rowData = row.data();

        if (!rowData.children || !rowData.children.length) return;

        if (row.child.isShown()) {
          row.child.hide();
          tr.removeClass('shown');
          $(this).html($(this).text().replace('▼','▶'));
        } else {
          const childTable = buildChildTable(rowData.children, (L2 === 'day' ? 'Datum' : (L2 === 'affiliate' ? 'Affiliate ID' : 'Offer ID')));
          row.child(childTable).show();
          tr.addClass('shown');
          $(this).html($(this).text().replace('▶','▼'));

          // Tweede niveau klik (voor L3)
          $(childTable).on('click', 'td.control', function () {
            const tr2 = $(this).closest('tr');
            const hasChildren = tr2.get(0).dataset.hasChildren === '1';
            const children = tr2.get(0)._children || [];
            if (!hasChildren) return;

            // toggle subtable
            if (tr2.next().hasClass('sub-open')) {
              tr2.next().remove();
              $(this).html($(this).text().replace('▼','▶'));
            } else {
              const subRow = document.createElement('tr');
              subRow.className = 'sub-open';
              const td = document.createElement('td');
              td.colSpan = 3;
              const subTable = buildChildTable(children, (L3 === 'day' ? 'Datum' : (L3 === 'affiliate' ? 'Affiliate ID' : 'Offer ID')));
              td.appendChild(subTable);
              subRow.appendChild(td);
              tr2.after(subRow);
              $(this).html($(this).text().replace('▶','▼'));
            }
          });
        }
      });
    }

    // Events
    document.getElementById('apply').addEventListener('click', loadTable);

    // Init (optioneel: 30 dagen standaard)
    (function setDefaultDates() {
      const toISO = (d) => d.toISOString().slice(0,10);
      const now = new Date();
      const past = new Date(); past.setDate(now.getDate() - 30);
      document.getElementById('fromDate').value = toISO(past);
      document.getElementById('toDate').value = toISO(now);
    })();

    (async () => {
      try {
        await fetchFilters();
        await loadTable();
      } catch (e) {
        console.error(e);
        alert('Kon dashboard data niet laden.');
      }
    })();
  </script>
</body>
</html>
