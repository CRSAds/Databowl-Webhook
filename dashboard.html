<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Lead Dashboard</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 20px; }
    .filters { margin-bottom: 20px; display:flex; gap:16px; flex-wrap:wrap; }
    table { width: 100%; }
  </style>
</head>
<body>
  <h1>Lead Dashboard</h1>

  <div class="filters">
    <label>Offer ID:
      <select id="offerFilter"><option value="">Alle</option></select>
    </label>
    <label>Campaign ID:
      <select id="campaignFilter"><option value="">Alle</option></select>
    </label>
    <label>Affiliate ID:
      <select id="affiliateFilter"><option value="">Alle</option></select>
    </label>
    <label>Sub ID:
      <select id="subFilter"><option value="">Alle</option></select>
    </label>
    <label>Vanaf:
      <input type="date" id="fromDate" />
    </label>
    <label>Tot:
      <input type="date" id="toDate" />
    </label>
    <button id="apply">Toepassen</button>
  </div>

  <table id="leadsTable" class="display"></table>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script>
    // Jouw Vercel base URL (zelfde origin als de pagina zelf; leeg laten werkt ook)
    const BASE = ''; // '' betekent: zelfde domein, bv https://databowl-webhook.vercel.app

    async function fetchFilters() {
      const r = await fetch(`${BASE}/api/dashboard-filters`);
      const j = await r.json();
      const { offer_ids, campaign_ids, affiliate_ids, sub_ids } = j.data;

      const fill = (id, values) => {
        const sel = document.getElementById(id);
        values.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v; opt.textContent = v;
          sel.appendChild(opt);
        });
      };
      fill('offerFilter', offer_ids);
      fill('campaignFilter', campaign_ids);
      fill('affiliateFilter', affiliate_ids);
      fill('subFilter', sub_ids);
    }

    async function fetchAggregate() {
      const params = new URLSearchParams();
      const v = (id) => document.getElementById(id).value;

      if (v('offerFilter'))     params.append('offer_id', v('offerFilter'));
      if (v('campaignFilter'))  params.append('campaign_id', v('campaignFilter'));
      if (v('affiliateFilter')) params.append('affiliate_id', v('affiliateFilter'));
      if (v('subFilter'))       params.append('sub_id', v('subFilter'));
      if (v('fromDate'))        params.append('date_from', v('fromDate'));
      if (v('toDate'))          params.append('date_to', v('toDate'));

      const r = await fetch(`${BASE}/api/dashboard-aggregate?` + params.toString());
      if (!r.ok) throw new Error('Failed to fetch aggregate');
      const j = await r.json();
      return j.data || [];
    }

    function toNLDate(d) {
      // r.created_at kan string/datetime zijn; we tonen dag
      const dt = new Date(d);
      if (isNaN(dt)) return d;
      return dt.toLocaleDateString('nl-NL');
    }

    async function loadTable() {
      const rows = await fetchAggregate();

      // Directus aggregate response: elke rij heeft created_at + countDistinct.t_id + sum.cost
      const tableData = rows.map(r => ({
        date: toNLDate(r.created_at),
        leads: r.countDistinct?.t_id || 0,
        cost: r.sum?.cost ? Number(r.sum.cost).toFixed(2) : '0.00'
      }));

      if ($.fn.dataTable.isDataTable('#leadsTable')) {
        const t = $('#leadsTable').DataTable();
        t.clear().rows.add(tableData).draw();
      } else {
        $('#leadsTable').DataTable({
          data: tableData,
          order: [[0, 'desc']],
          columns: [
            { title: 'Datum', data: 'date' },
            { title: 'Aantal Leads', data: 'leads' },
            { title: 'Kosten', data: 'cost' }
          ]
        });
      }
    }

    document.getElementById('apply').addEventListener('click', loadTable);

    // init
    (async () => {
      await fetchFilters();
      await loadTable();
    })();
  </script>
</body>
</html>
