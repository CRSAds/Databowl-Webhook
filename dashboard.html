<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Lead Dashboard</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 16px; }
    .filters { margin-bottom: 20px; display:flex; gap:16px; flex-wrap:wrap; align-items: end; }
    .filters label { display:flex; flex-direction:column; font-size: 12px; gap:6px; }
    .filters select, .filters input[type="date"] { padding: 6px 8px; min-width: 160px; }
    button#apply { height: 36px; padding: 0 14px; cursor: pointer; }
    table { width: 100%; }
    .totals { margin-top: 10px; font-weight: 600; }
  </style>
</head>
<body>
  <h1>Lead Dashboard</h1>

  <div class="filters">
    <label>Offer ID
      <select id="offerFilter"><option value="">Alle</option></select>
    </label>
    <label>Campaign ID
      <select id="campaignFilter"><option value="">Alle</option></select>
    </label>
    <label>Affiliate ID
      <select id="affiliateFilter"><option value="">Alle</option></select>
    </label>
    <label>Sub ID
      <select id="subFilter"><option value="">Alle</option></select>
    </label>
    <label>Vanaf
      <input type="date" id="fromDate" />
    </label>
    <label>Tot
      <input type="date" id="toDate" />
    </label>
    <button id="apply">Toepassen</button>
  </div>

  <table id="leadsTable" class="display"></table>
  <div class="totals" id="totals"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script>
    // Zelfde origin als deze pagina (https://databowl-webhook.vercel.app)
    const BASE = '';

    // Helpers
    const toNL = (yyyy_mm_dd) => {
      // yyyy-mm-dd → nl-NL datum
      const [y,m,d] = String(yyyy_mm_dd).split('-').map(Number);
      if (!y || !m || !d) return yyyy_mm_dd;
      return new Date(Date.UTC(y, m-1, d)).toLocaleDateString('nl-NL');
    };

    async function fetchFilters() {
      const r = await fetch(`${BASE}/api/dashboard-filters`);
      if (!r.ok) throw new Error('Kon filters niet laden');
      const { data } = await r.json();
      const { offer_ids, campaign_ids, affiliate_ids, sub_ids } = data;

      const fill = (id, values) => {
        const sel = document.getElementById(id);
        values.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v; opt.textContent = v;
          sel.appendChild(opt);
        });
      };
      fill('offerFilter', offer_ids);
      fill('campaignFilter', campaign_ids);
      fill('affiliateFilter', affiliate_ids);
      fill('subFilter', sub_ids);
    }

    async function fetchAggregate() {
      const params = new URLSearchParams();
      const v = (id) => document.getElementById(id).value;

      if (v('offerFilter'))     params.append('offer_id', v('offerFilter'));
      if (v('campaignFilter'))  params.append('campaign_id', v('campaignFilter'));
      if (v('affiliateFilter')) params.append('affiliate_id', v('affiliateFilter'));
      if (v('subFilter'))       params.append('sub_id', v('subFilter'));
      if (v('fromDate'))        params.append('date_from', v('fromDate'));
      if (v('toDate'))          params.append('date_to', v('toDate'));

      const r = await fetch(`${BASE}/api/dashboard-aggregate?` + params.toString());
      if (!r.ok) throw new Error('Kon aggregatie niet laden');
      const { data } = await r.json(); // [{ date: "YYYY-MM-DD", leads: <int>, cost: <number> }]
      return data || [];
    }

    function renderTotals(rows) {
      const totalLeads = rows.reduce((s, r) => s + Number(r.leads || 0), 0);
      const totalCost  = rows.reduce((s, r) => s + Number(r.cost  || 0), 0);
      document.getElementById('totals').textContent =
        `Totaal: ${totalLeads.toLocaleString('nl-NL')} leads • Kosten € ${totalCost.toFixed(2)}`;
    }

    async function loadTable() {
      const rows = await fetchAggregate();

      const tableData = rows.map(r => ({
        date: toNL(r.date),               // r.date is al per dag (YYYY-MM-DD)
        leads: Number(r.leads || 0),
        cost:  Number(r.cost  || 0).toFixed(2)
      }));

      renderTotals(rows);

      if ($.fn.dataTable.isDataTable('#leadsTable')) {
        const t = $('#leadsTable').DataTable();
        t.clear().rows.add(tableData).draw();
      } else {
        $('#leadsTable').DataTable({
          data: tableData,
          order: [[0, 'desc']],
          columns: [
            { title: 'Datum', data: 'date' },
            { title: 'Aantal Leads', data: 'leads' },
            { title: 'Kosten', data: 'cost' }
          ]
        });
      }
    }

    // Events
    document.getElementById('apply').addEventListener('click', loadTable);

    // Init (optioneel: standaard zet "Vanaf" op 30 dagen terug)
    (function setDefaultDates() {
      const toISO = (d) => d.toISOString().slice(0,10);
      const now = new Date();
      const past = new Date(); past.setDate(now.getDate() - 30);
      document.getElementById('fromDate').value = toISO(past);
      document.getElementById('toDate').value = toISO(now);
    })();

    (async () => {
      try {
        await fetchFilters();
        await loadTable();
      } catch (e) {
        console.error(e);
        alert('Kon dashboard data niet laden.');
      }
    })();
  </script>
</body>
</html>
